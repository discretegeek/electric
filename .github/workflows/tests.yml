name: Photon Test Suite
on: [push]
jobs:
  photon-jvm:
    runs-on: [ubuntu-latest]
    timeout-minutes: 5
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: 'recursive'

    - run: git status && ls vendor

    - run: sudo apt update && sudo apt install maven -y
    
    - uses: actions/setup-java@v2
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Cache local Maven repository
      uses: actions/cache@v2
      with:
         path: ~/.m2/repository
         key: ${{ runner.os }}-maven-${{ hashFiles('**/deps.edn') }}
         restore-keys: |
           ${{ runner.os }}-maven-
    
    - run: mvn --version

    - name: Set Missionary version to b.27
      run: mvn versions:set -DnewVersion=b.27-SNAPSHOT --file vendor/missionary/pom.xml

    - name: Install Missionary from submodule
      run: mvn -B --file vendor/missionary/pom.xml clean compile install

    - name: Install clojure tools
      uses: DeLaGuardo/setup-clojure@3.4
      with:
        cli: 1.11.1.1113
 
    - name: prep
      run: clojure -A:test -P

    - name: build
      run: clojure -T:build compile-java

    - name: Run tests
      run: ./ci/run_tests_jvm.sh
        
  photon-nodejs:
    # if: ${{ false }} # Disabled until we fix the cljs test suite locally
    runs-on: [ubuntu-latest]
    timeout-minutes: 5
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: 'recursive'

    - run: git status && ls vendor

    - run: sudo apt update && sudo apt install maven -y
    
    - uses: actions/setup-java@v2
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Cache local Maven repository
      uses: actions/cache@v2
      with:
         path: ~/.m2/repository
         key: ${{ runner.os }}-maven-${{ hashFiles('**/deps.edn') }}
         restore-keys: |
           ${{ runner.os }}-maven-
    
    - run: mvn --version

    - name: Set Missionary version to b.27
      run: mvn versions:set -DnewVersion=b.27-SNAPSHOT --file vendor/missionary/pom.xml

    - name: Install Missionary from submodule
      run: mvn -B --file vendor/missionary/pom.xml clean compile install

    - name: Install clojure tools
      uses: DeLaGuardo/setup-clojure@3.4
      with:
        cli: 1.11.1.1113
 
    - name: prep
      run: clojure -A:test -P

    - name: build
      run: clojure -T:build compile-java

    - name: Use Node.js
      uses: actions/setup-node@v2
      with:
        node-version: 14.x

    - name: NPM install
      run: npm install

    - name: Install Shadow
      run: npm install shadow-cljs

    - name: Run Tests
      run: ./ci/run_tests_node.sh
